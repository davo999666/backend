name: CI/CD Deploy to EC2 with Docker

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      # 1️⃣ Setup SSH with your EC2 key
      - name: Setup SSH
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.EC2_SSH_KEY }}

      # 2️⃣ Deploy and build Docker on EC2
      - name: Deploy on EC2
        env:
          ADMIN_PASSWORD: ${{ secrets.ADMIN_PASSWORD }}
          DB_PORT: ${{ secrets.DB_PORT }}
          DB_URL: ${{ secrets.DB_URL }}
          EMAIL_PASS: ${{ secrets.EMAIL_PASS }}
          EMAIL_USER: ${{ secrets.EMAIL_USER }}
          PORT: ${{ secrets.PORT }}
        run: |
          ssh -o StrictHostKeyChecking=no ec2-user@3.239.93.96 '
            mkdir -p /home/ec2-user/myapp
            cd /home/ec2-user/myapp

            # Clone repo if folder empty, else pull latest
            if [ -z "$(ls -A /home/ec2-user/myapp)" ]; then
              git clone https://github.com/YOUR_USERNAME/YOUR_REPO.git .
            else
              git reset --hard
              git pull
            fi

            # Build Docker image with build args
            docker build \
              --build-arg ADMIN_PASSWORD=$ADMIN_PASSWORD \
              --build-arg DB_PORT=$DB_PORT \
              --build-arg DB_URL=$DB_URL \
              --build-arg EMAIL_PASS=$EMAIL_PASS \
              --build-arg EMAIL_USER=$EMAIL_USER \
              --build-arg PORT=$PORT \
              -t myapp:latest .

            # Stop old container if running
            docker stop myapp || true
            docker rm myapp || true

            # Run new container
            docker run -d --name myapp -p $PORT:$PORT myapp:latest
          '
