name: CI/CD Deploy to EC2 with Docker

on:
  push:
    branches:
      - main  # Deploy when pushing to main branch

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      # 1️⃣ Setup SSH with your EC2 key
      - name: Setup SSH
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.EC2_SSH_KEY }}

      # 2️⃣ Deploy and build Docker on EC2
      - name: Deploy on EC2
        run: |
          ssh -o StrictHostKeyChecking=no ubuntu@3.239.93.96 "
            # Create app directory if not exists
            mkdir -p /home/ubuntu/myapp
            cd /home/ubuntu/myapp

            # Clone repo if folder empty, else pull latest
            if [ -z \"\$(ls -A /home/ubuntu/myapp)\" ]; then
              git clone https://github.com/YOUR_USERNAME/YOUR_REPO.git .
            else
              git reset --hard
              git pull
            fi

            # Build Docker image with secrets
            docker build \
              --build-arg ADMIN_PASSWORD=${{ secrets.ADMIN_PASSWORD }} \
              --build-arg DB_PORT=${{ secrets.DB_PORT }} \
              --build-arg DB_URL=${{ secrets.DB_URL }} \
              --build-arg EMAIL_PASS=${{ secrets.EMAIL_PASS }} \
              --build-arg EMAIL_USER=${{ secrets.EMAIL_USER }} \
              --build-arg PORT=${{ secrets.PORT }} \
              -t myapp:latest .

            # Stop old container if running
            docker stop myapp || true
            docker rm myapp || true

            # Run new container
            docker run -d --name myapp -p ${{ secrets.PORT }}:${{ secrets.PORT }} myapp:latest
          "
